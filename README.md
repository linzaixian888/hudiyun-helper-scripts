# 狐蒂云自动化脚本

用于狐蒂云（szhdy.com）的自动化工具集，包含自动抢购和商品识别两个脚本。

## 安装说明

1. 安装浏览器扩展 [Tampermonkey](https://www.tampermonkey.net/)
2. 打开 Tampermonkey 管理面板
3. 创建新脚本，复制对应脚本的完整代码并保存
4. 访问狐蒂云网站，脚本会自动运行

---

## 狐蒂云自动抢购.js - 使用说明

**注意**：脚本需要在具体商品页面运行，不要在活动列表页面使用。因此提供了两个脚本：先用"商品识别"脚本找到有效的商品 PID，再用"自动抢购"脚本进行抢购。

例如：最近的三周年香港PID：1859，地址：

https://www.szhdy.com/cart?action=configureproduct&pid=1859

其他商品PID

Tips for collapsed sections

### You can add a header

You can add text within a collapsed section.

You can add an image or a code block, too.

`ruby puts "Hello World"`

- 11.01更新

### 检测模式

- 全天候检测（all_day）
  
  - 进入或切换到该模式后，开始时间自动设为当前时间，结束时间输入被隐藏。
  - 0-24 小时持续检测配置的商品 ID；发现可购立即点击购买。
  - 连续未发现商品会累计失败次数，达到阈值（默认 5 次）后自动刷新页面再继续。
  - 面板状态显示“全天候(运行中)”，倒计时区域固定提示“全天候：0-24点”。
  - 进入支付页自动暂停；进入购物车页自动勾选并提交，提交后自动暂停。

- 平时三时间段（three_periods）
  
  - 每天在 3 个时间窗口内运行：7:00-9:00、13:00-14:00、17:00-19:00。
  - 窗口外：面板显示“等待三时间段”，倒计时显示距下个窗口开始的时间。
  - 窗口内：状态“抢购中(三段)”，倒计时显示距本窗口结束的时间；执行检测与自动下单。
  - 连续未发现商品达到阈值（默认 5 次）会自动刷新页面；一个窗口结束会自动等待下个窗口。

### 页面识别与通用检测

- 特殊页面
  
  - 支付页：自动暂停（不执行操作）。
  - 购物车页：自动勾选支付/条款并提交订单，提交后自动暂停。
  - 保护页（如配置页）：不刷新，仅尝试必要操作。

- 通用检测（不依赖特定 URL）
  
  - 只要页面存在“商品卡 + 按钮”，就会尝试检测与点击：
    - 直接匹配按钮链接中的 pid/gid：`.form-footer-butt[href*="pid=ID"], a[href*="gid=ID"]`。
    - 兼容容器属性：`[data-id="ID"]` 或 `[data-gid="ID"]` 内的按钮。

### 功能特性

- **自动关闭弹窗**：可选择自动关闭"已阅读知晓"等提示弹窗
- **购物车重复提交**：可选开启，在购物车页面自动重复提交订单
- **配置自动保存**：所有配置选项修改后自动保存，无需手动点击保存按钮
- **面板缩放**：支持将控制面板缩小为侧边栏模式，节省屏幕空间

### 配置与存储

- 所有配置与运行状态持久化在浏览器 localStorage：
  - 配置：`hudiyun_config`
  - 运行状态（开始/暂停）：`hudiyun_running`
- 模式为圆点单选，切换即自动保存；其它配置修改后自动保存，无需手动操作

### 关键参数

- 检测间隔（ms）：默认 800，可在面板调整。
- 自动刷新阈值（次）：默认 5。以“检测次数”计数，不是秒数。
  - 例：阈值=5、间隔=1000ms 时，第一次检测在 t=0 触发计数，所以约在 ~4.5s 左右刷新（包含一次刷新延时）。

### 常见问题

- 看不到自动检测/点击？
  - 打开控制台检查是否存在以下元素之一：
    - `document.querySelector('.form-footer-butt[href*="pid=目标ID"]')`
    - `document.querySelector('[data-id="目标ID"] .form-footer-butt')`
    - `document.querySelector('a[href*="gid=目标ID"]')`

- 有时候购物车会产生重复订单，这时需要人工手动删除，直到剩下一个，然后直接进到支付页开脚本等着，脚本会帮你重复提交

---

## 狐蒂云商品识别 - 使用说明

### 功能简介

自动在指定 PID 范围内扫描狐蒂云商品页，识别有效的商品配置页面，并记录成功的商品 ID、标题和价格信息。适合用于批量发现可购买的商品。

### 使用方法

1. **设置扫描范围**
   
   - 起始 PID：要扫描的第一个商品 ID
   - 结束 PID：要扫描的最后一个商品 ID
   - 检查间隔：每个页面检查的间隔时间（毫秒）

2. **可选功能**
   
   - **获取基础价格**：勾选后会在记录商品时同时保存价格信息（格式：¥价格）

3. **开始扫描**
   
   - 点击"开始"按钮开始自动扫描
   - 脚本会自动跳转到每个 PID 的页面进行检查
   - 识别成功的 PID 会自动记录并显示在列表中（格式：PID 商品标题 价格）
   - 脚本会自动关闭弹窗，无需手动处理

4. **查看结果**
   
   - 成功的 ID 会实时显示在面板中（包含 PID、标题、价格）
   - 失败的 ID 会单独显示，包含错误代码（如 404、502 等）
   - 点击"复制"按钮可复制所有成功记录（每行一个）
   - 点击"清空"按钮可清除成功记录
   - 点击"清空失败"按钮可清除失败记录

### 识别逻辑与错误处理

脚本通过检测以下元素判断页面是否为有效的商品页：

**成功的特征：**

- 包含产品名称或标题
- 有"周期"选择按钮组
- 有配置选择器（CPU、内存等）
- 有"加入购物车"按钮

**失败的特征：**

- 显示多个地区导航菜单（导航页）
- 页面为空或显示错误信息（404、502 等）

**错误重试机制：**

- 检测到 404、502 等 HTTP 错误时，会自动等待"检查间隔"时间后刷新页面重新检测
- 如果第二次检测仍然失败，会记录该 PID 和错误代码到失败列表
- 可以随时查看失败列表并清空记录

### 配置与存储

- **配置自动保存**：修改任何配置后会自动保存，无需手动操作
- 配置存储在 `localStorage`: `hudiyun_scanner_config`
- 成功记录存储在 `localStorage`: `hudiyun_scanner_success`（格式：`[{pid, title, price}]`）
- 失败记录存储在 `localStorage`: `hudiyun_scanner_failed`（格式：`[{pid, code}]`）
- 脚本关闭后重新打开会保留之前的成功和失败记录
